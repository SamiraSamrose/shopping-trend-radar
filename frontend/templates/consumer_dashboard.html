<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumer Dashboard - Shopping Trend Radar</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ›’ Consumer Dashboard</h1>
            <p>Discover trending products, compare prices, and get smart buying recommendations</p>
        </div>

        <nav class="nav">
            <a href="/" class="nav-button">Home</a>
            <a href="/merchant" class="nav-button">Merchant Dashboard</a>
            <a href="/consumer" class="nav-button active">Consumer Dashboard</a>
            <a href="/demo" class="nav-button">Interactive Demo</a>
        </nav>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">What's Trending Now</div>
                    <div class="card-badge badge-success" id="trendingCount">0</div>
                </div>
                <p>Most popular products across all platforms</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Price Drop Alerts</div>
                    <div class="card-badge badge-warning" id="priceDropCount">0</div>
                </div>
                <p>Products with significant price reductions</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Gift Ideas</div>
                    <div class="card-badge badge-info" id="giftIdeasCount">0</div>
                </div>
                <p>Perfect gifts based on upcoming events</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Your Alerts</div>
                    <div class="card-badge badge-info" id="myAlertsCount">0</div>
                </div>
                <p>Custom trend notifications you've set up</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ðŸŽ‰ Upcoming Events & Recommendations</div>
                <button class="btn btn-secondary" onclick="refreshEvents()">Refresh</button>
            </div>
            <div class="event-timeline" id="eventsTimeline">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ðŸ”¥ Hot Products Right Now</div>
            </div>
            <div class="product-list" id="hotProductsList">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ðŸ’° Best Deals & Price Comparisons</div>
            </div>
            <div id="dealsContainer">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ðŸ“Š Social Proof & Popularity</div>
            </div>
            <div class="chart-container" style="height: 350px;">
                <canvas id="popularityChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">âš¡ Create Custom Alert</div>
            </div>
            <form id="alertForm" onsubmit="createCustomAlert(event)">
                <div class="form-group">
                    <label class="form-label">Alert Name</label>
                    <input type="text" class="form-input" id="alertName" placeholder="E.g., Tech Gadgets Alert" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Keywords (comma-separated)</label>
                    <input type="text" class="form-input" id="alertKeywords" placeholder="E.g., smartphone, laptop, headphones">
                </div>

                <div class="form-group">
                    <label class="form-label">Categories</label>
                    <select class="form-select" id="alertCategories" multiple>
                        <option value="Electronics">Electronics</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Beauty">Beauty</option>
                        <option value="Home & Garden">Home & Garden</option>
                        <option value="Sports & Outdoors">Sports & Outdoors</option>
                        <option value="Toys & Games">Toys & Games</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Minimum Trend Score</label>
                    <input type="range" class="form-input" id="alertMinScore" min="0" max="1" step="0.1" value="0.7">
                    <span id="alertMinScoreLabel">70%</span>
                </div>

                <div class="form-group">
                    <label class="form-label">Platforms</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <label><input type="checkbox" value="amazon"> Amazon</label>
                        <label><input type="checkbox" value="tiktok"> TikTok</label>
                        <label><input type="checkbox" value="youtube"> YouTube</label>
                        <label><input type="checkbox" value="instagram"> Instagram</label>
                        <label><input type="checkbox" value="etsy"> Etsy</label>
                        <label><input type="checkbox" value="walmart"> Walmart</label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">Create Alert</button>
            </form>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">ðŸ“¬ Your Active Alerts</div>
            </div>
            <div id="activeAlertsList">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script src="/static/js/api-client.js"></script>
    <script src="/static/js/charts.js"></script>
    <script>
        const userId = localStorage.getItem('userId') || 'demo_consumer_' + Date.now();
        localStorage.setItem('userId', userId);

        async function loadConsumerDashboard() {
            try {
                // Load trending products
                const products = await apiClient.getTrendingProducts({
                    min_score: 0.6,
                    limit: 30
                });

                document.getElementById('trendingCount').textContent = products.length;

                // Load upcoming events
                await loadUpcomingEvents();

                // Load hot products
                await loadHotProducts(products);

                // Load best deals
                await loadBestDeals(products);

                // Load user alerts
                await loadUserAlerts();

                // Update charts
                updatePopularityChart(products);

            } catch (error) {
                console.error('Error loading consumer dashboard:', error);
            }
        }

        async function loadUpcomingEvents() {
            try {
                const events = await apiClient.getEventRecommendations(60);
                const container = document.getElementById('eventsTimeline');

                if (events.length === 0) {
                    container.innerHTML = '<p>No upcoming events in the next 60 days.</p>';
                    return;
                }

                document.getElementById('giftIdeasCount').textContent = events.reduce(
                    (sum, e) => sum + e.recommended_products.length, 0
                );

                container.innerHTML = events.map(event => `
                    <div class="event-item fade-in">
                        <div class="event-date">
                            ${new Date(event.event_date).toLocaleDateString('en-US', { 
                                month: 'long', 
                                day: 'numeric', 
                                year: 'numeric' 
                            })}
                            (${event.days_until_event} days away)
                        </div>
                        <div class="event-title">${event.event_name}</div>
                        <div style="margin-top: 10px;">
                            <div class="card-badge badge-${event.buying_urgency === 'high' ? 'danger' : 
                                event.buying_urgency === 'medium' ? 'warning' : 'info'}">
                                ${event.buying_urgency.toUpperCase()} URGENCY
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Top Recommendations:</strong>
                            <div class="product-platforms" style="margin-top: 8px;">
                                ${event.recommended_products.slice(0, 5).map(p => `
                                    <span class="platform-tag" style="cursor: pointer;" 
                                          onclick="viewProductDetails('${p.id}')">
                                        ${p.name.substring(0, 30)}${p.name.length > 30 ? '...' : ''}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 10px;" 
                                onclick="viewEventDetails('${event.event_name}')">
                            View All Products
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        async function loadHotProducts(products) {
            const container = document.getElementById('hotProductsList');
            
            // Sort by trend score
            const hotProducts = products
                .sort((a, b) => b.trend_score - a.trend_score)
                .slice(0, 10);

            container.innerHTML = hotProducts.map(product => `
                <div class="product-item fade-in">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-category">${product.category}</div>
                        <div class="product-platforms">
                            ${product.platforms.map(p => `<span class="platform-tag">${p}</span>`).join('')}
                        </div>
                        <div style="margin-top: 10px;">
                            <div class="card-badge badge-${product.status === 'rising' ? 'success' : 
                                product.status === 'peak' ? 'warning' : 'info'}">
                                ${product.status.toUpperCase()}
                            </div>
                        </div>
                    </div>
                    <div class="product-metrics">
                        <div class="trend-score">${(product.trend_score * 100).toFixed(0)}%</div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary btn-sm" 
                                    onclick="viewConsumerInsights('${product.id}')">
                                View Insights
                            </button>
                            <button class="btn btn-secondary btn-sm" 
                                    onclick="compareProduct('${product.name}')">
                                Compare Prices
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadBestDeals(products) {
            const container = document.getElementById('dealsContainer');
            
            // Mock price comparison data
            const deals = products.slice(0, 5).map(product => ({
                product_name: product.name,
                platforms: [
                    { name: 'Amazon', price: Math.random() * 100 + 20, reviews: Math.floor(Math.random() * 1000) },
                    { name: 'Walmart', price: Math.random() * 100 + 20, reviews: Math.floor(Math.random() * 500) },
                    { name: 'eBay', price: Math.random() * 100 + 20, reviews: Math.floor(Math.random() * 300) }
                ]
            }));

            container.innerHTML = deals.map(deal => {
                const bestDeal = deal.platforms.reduce((min, p) => 
                    p.price < min.price ? p : min
                );
                const savings = deal.platforms.reduce((max, p) => 
                    Math.max(max, p.price - bestDeal.price), 0
                );

                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <h4>${deal.product_name}</h4>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Platform</th>
                                    <th>Price</th>
                                    <th>Reviews</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${deal.platforms.map(platform => `
                                    <tr ${platform.name === bestDeal.name ? 'style="background: rgba(16, 185, 129, 0.1);"' : ''}>
                                        <td><strong>${platform.name}</strong></td>
                                        <td>$${platform.price.toFixed(2)}</td>
                                        <td>${platform.reviews} reviews</td>
                                        <td>
                                            ${platform.name === bestDeal.name ? 
                                                '<span class="card-badge badge-success">BEST DEAL</span>' : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${savings > 5 ? `
                            <div class="alert alert-success" style="margin-top: 10px;">
                                ðŸ’° Save up to $${savings.toFixed(2)} by buying from ${bestDeal.name}!
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function loadUserAlerts() {
            try {
                const alerts = await apiClient.getUserAlerts(userId);
                const container = document.getElementById('activeAlertsList');

                document.getElementById('myAlertsCount').textContent = alerts.filter(a => a.active).length;

                if (alerts.length === 0) {
                    container.innerHTML = '<p>You haven\'t created any alerts yet. Use the form above to create one!</p>';
                    return;
                }

                container.innerHTML = alerts.map(alert => `
                    <div class="card" style="margin-bottom: 15px;">
                        <div class="card-header">
                            <div class="card-title">${alert.keywords.join(', ') || 'Custom Alert'}</div>
                            <div class="card-badge badge-${alert.active ? 'success' : 'secondary'}">
                                ${alert.active ? 'Active' : 'Inactive'}
                            </div>
                        </div>
                        <p><strong>Categories:</strong> ${alert.categories.join(', ') || 'All'}</p>
                        <p><strong>Min Score:</strong> ${(alert.min_trend_score * 100).toFixed(0)}%</p>
                        <p><strong>Platforms:</strong> ${alert.platforms.join(', ') || 'All'}</p>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-secondary btn-sm" 
                                    onclick="checkAlertNow('${alert.id}')">
                                Check Now
                            </button>
                            <button class="btn btn-danger btn-sm" 
                                    onclick="deleteAlert('${alert.id}')">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        function updatePopularityChart(products) {
            const platformPopularity = {};
            
            products.forEach(product => {
                product.platforms.forEach(platform => {
                    platformPopularity[platform] = (platformPopularity[platform] || 0) + product.trend_score;
                });
            });

            const data = {
                labels: Object.keys(platformPopularity),
                values: Object.values(platformPopularity)
            };

            chartManager.createViralVelocityChart('popularityChart', data);
        }

        async function viewConsumerInsights(productId) {
            try {
                const insights = await apiClient.getConsumerInsights(productId);
                const product = await apiClient.getProductDetails(productId);

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Consumer Insights: ${product.name}</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value">${(insights.popularity_score * 100).toFixed(0)}%</div>
                                    <div class="stat-label">Popularity Score</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">${insights.social_proof.total_engagement.toLocaleString()}</div>
                                    <div class="stat-label">Total Engagement</div>
                                </div>
                            </div>

                            <div class="alert alert-${insights.price_trend === 'increasing' ? 'danger' : 
                                insights.price_trend === 'decreasing' ? 'success' : 'info'}">
                                <strong>Price Trend:</strong> ${insights.price_trend.toUpperCase()}
                            </div>

                            <div class="alert alert-info">
                                <strong>Best Time to Buy:</strong> ${insights.best_time_to_buy}
                            </div>

                            <h3>Gift Suitability</h3>
                            <p><strong>Suitable for:</strong> ${insights.gift_suitability.suitable_for.join(', ') || 'General use'}</p>
                            <p><strong>Age Groups:</strong> ${insights.gift_suitability.age_groups.join(', ')}</p>

                            ${insights.similar_trending_products.length > 0 ? `
                                <h3>Similar Trending Products</h3>
                                <div class="product-platforms">
                                    ${insights.similar_trending_products.map(pid => 
                                        `<span class="platform-tag" onclick="viewConsumerInsights('${pid}')">${pid}</span>`
                                    ).join('')}
                                </div>
                            ` : ''}

                            <button class="btn btn-primary btn-block" onclick="compareProduct('${product.name}')">
                                Compare Prices Across Platforms
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

            } catch (error) {
                console.error('Error loading consumer insights:', error);
                alert('Error loading insights');
            }
        }

        async function createCustomAlert(event) {
            event.preventDefault();

            const keywords = document.getElementById('alertKeywords').value
                .split(',')
                .map(k => k.trim())
                .filter(k => k);

            const categorySelect = document.getElementById('alertCategories');
            const categories = Array.from(categorySelect.selectedOptions).map(o => o.value);

            const platformCheckboxes = event.target.querySelectorAll('input[type="checkbox"]:checked');
            const platforms = Array.from(platformCheckboxes).map(cb => cb.value);

            const alertData = {
                user_id: userId,
                keywords: keywords,
                categories: categories,
                min_trend_score: parseFloat(document.getElementById('alertMinScore').value),
                platforms: platforms
            };

            try {
                await apiClient.createAlert(alertData);
                alert('Alert created successfully! You will be notified when matching products are found.');
                event.target.reset();
                await loadUserAlerts();
            } catch (error) {
                console.error('Error creating alert:', error);
                alert('Error creating alert');
            }
        }

        async function checkAlertNow(alertId) {
            try {
                const result = await apiClient.checkAlert(alertId);
                
                if (result.triggered) {
                    alert(`Alert triggered! Found ${result.matching_products.length} matching products.`);
                } else {
                    alert('No matching products found at this time.');
                }
            } catch (error) {
                console.error('Error checking alert:', error);
                alert('Error checking alert');
            }
        }

        async function deleteAlert(alertId) {
            if (!confirm('Are you sure you want to delete this alert?')) return;

            try {
                await apiClient.deleteAlert(alertId);
                alert('Alert deleted successfully');
                await loadUserAlerts();
            } catch (error) {
                console.error('Error deleting alert:', error);
                alert('Error deleting alert');
            }
        }

        function viewEventDetails(eventName) {
            alert(`View all products for ${eventName} - Full implementation coming soon!`);
        }

        async function refreshEvents() {
            await loadUpcomingEvents();
            alert('Events refreshed!');
        }

        // Update min score label
        document.addEventListener('DOMContentLoaded', () => {
            const slider = document.getElementById('alertMinScore');
            if (slider) {
                slider.addEventListener('input', (e) => {
                    document.getElementById('alertMinScoreLabel').textContent = 
                        `${(e.target.value * 100).toFixed(0)}%`;
                });
            }

            loadConsumerDashboard();
        });

        // Export functions
        window.viewConsumerInsights = viewConsumerInsights;
        window.createCustomAlert = createCustomAlert;
        window.checkAlertNow = checkAlertNow;
        window.deleteAlert = deleteAlert;
        window.viewEventDetails = viewEventDetails;
        window.refreshEvents = refreshEvents;
    </script>
</body>
</html>
